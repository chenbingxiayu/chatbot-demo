<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Dialogggg</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.14/vue.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/vue/latest/vue.min.js"></script>


    {% load static %}
    <script src="{% static 'botui-master/build/botui.js' %}"></script>
    <link rel="stylesheet" href="{% static 'botui-master/build/botui.min.css' %}" />
    <link rel="stylesheet" href="{% static 'botui-master/build/botui-theme-default.css' %}" />

    <!--<script src="https://cdn.jsdelivr.net/npm/botui/build/botui.js"></script>-->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" /> -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" /> -->


    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="http://malsup.github.io/jquery.form.js"></script>


    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css" rel="stylesheet">


</head>

<body>
    {% block body %}
    <div class="container" style="background-color: #f7f8f8">
        <div class="jumbotron" style="background-color: #f7f8f8">

            <br>
            <br>
        </div>
        <div class="row">
            <div class="col-md-3"></div>
            <div class="col-md-6">
                <div id="chatbox" style="height: 600px">
                    <bot-ui style="background-color: aliceblue;"></bot-ui>
                </div>
            </div>
            <div class="col-md-3"></div>
        </div>
        <div class="jumbotron" style="background-color: #f7f8f8">
            <br>
            <br>
        </div>
    </div>

</body>
{% endblock body %}



{% block javascript %}
{% endblock javascript %}
<script>

    var office_hour = true;
    var botui = new BotUI('chatbox');
    var content = document.getElementsByTagName('chatbox');
    var user_input = 'default';
    var netid = 0;
    var passwd = 0;
    var score = 0;
    var answers = {};
    var name = 'User';

    login().then(
        //     verification
        // ).then(
        //     select_language
        // ).then(
        //     get_name
        // ).then(
        //     T_and_C
        // ).then(
        questions
    )

    function login() {
        return botui.message.add({
            content: 'Hello (Greeting Message 1), Are you a student in PolyU?'
        }).then(function () {
            return botui.action.button({
                addMessage: false,
                action: [{
                    text: 'Yes',
                    value: 'yes'
                }, {
                    text: 'No',
                    value: 'no'
                }]
            })
        }).then(function (res) {
            if (res.value == 'no') {
                botui.message.human({
                    delay: 500,
                    content: 'No'
                });
                botui.message.add({
                    delay: 700,
                    content: 'Sorry! We only server for PolyU students.'
                });
                botui.message.add({
                    delay: 900,
                    content: 'Bye bye!'
                });
                end();
            } else {
                botui.message.human({
                    delay: 500,
                    content: res.text
                })
            }
        })
    }

    function verification() {
        return botui.message.bot({
            delay: 500,
            content: 'Please input your PolyU netid and Password:'
        }).then(function () {
            return botui.action.text({
                addMessage: false,
                action: {
                    size: 30,
                    placeholder: 'PolyU netid'
                }
            });
        }).then(function (res) {
            netid = res.value;
            return botui.action.text({
                addMessage: false,
                action: {
                    size: 30,
                    sub_type: 'password',
                    placeholder: 'passwd'
                }
            });
        }).then(function (res) {
            passwd = res.value;
            /*
             ************************
             ## netid & passwd has stored in variables.
             This part we need backend verification.
            */
        })
    }

    function select_language() {
        return botui.message.bot({
            delay: 100,
            content: '請選擇語言 Please select your language'
        }).then(function () {
            return botui.action.select({
                action: {
                    placeholder: "Please select a language",
                    value: '2',
                    options: [
                        { value: "0", text: "繁體中文" },
                        { value: "1", text: "简体中文" },
                        { value: "2", text: "English" },
                    ],
                    button: {
                        icon: 'check',
                        label: 'OK'
                    }
                }
            })
        }).then(function (res) {
            console.log(res.value)
        })
    }

    function get_name() {
        return botui.message.bot({
            loading: true,
            delay: 1000,
            content: 'Hi there! I\'m Polly, your virtual Chatbot. My mission is to help identifying your service need and rendering you appropriate services, i.e. online chat, face-to-face counselling booking and online psycho-education materials.<br/> <br/>For enquiries about other SAO services, please visit the website:<br/>***[https://www.polyu.edu.hk/sao/](https://www.polyu.edu.hk/sao/)*** '
        }).then(function () {
            return botui.message.bot({
                loading: true,
                delay: 700,
                content: 'May I know your name?'
            })
        }).then(function () {
            return botui.action.text({
                addMessage: true,
                action: {
                    size: 30,
                    placeholder: 'Nickname'
                }
            });
        }).then(function (res) {
            name = res.value;
        })
    }


    function T_and_C() {
        return botui.message.bot({
            loading: true,
            delay: 500,
            content: 'Hi ' + name + '. Before using \"My Polly\", you must read and accept the terms and conditions.',
        }).then(function () {
            return botui.action.button({
                addMessage: false,
                action: [{
                    text: 'Read the Terms and Conditions',
                }]
            }).then(function (res) {
                // TODO  a new website about T&C
            })
        }).then(function () {
            return botui.message.bot({
                loading: true,
                delay: 500,
                content: 'Important Notes:<br/>In case of emergency and when there is an imminent risk to the safety of the student or others, please call 999 or go th the nearest emergency service \/ A&E service. Please refer to the CWS website for more emergency support information.',
            }).then(function () {
                return botui.action.button({
                    addMessage: false,
                    action: [{
                        text: 'Emergency support information',
                    }]
                }).then(function (res) {
                    // TODO  a new website about ESI
                })
            })
        }).then(function () {
            return botui.message.bot({
                loading: true,
                delay: 500,
                content: 'By clicking \"Hi, Polly\" to accept the above terms and conditions.'
            }).then(function () {
                return botui.action.button({
                    addMessage: true,
                    action: [
                        { text: 'No, I stop here.', value: false },
                        { text: 'Hi, Polly', value: true },
                    ]
                }).then(function (res) {
                    if (res.value == false) {
                        botui.message.bot({
                            loading: true,
                            delay: 500,
                            content: 'You are always welcome to contact us at 27666800 for enquiries.',
                        });
                        end();
                    }
                })
            })
        });
    }

    function questions() {
        return botui.message.bot({
            loading: true,
            delay: 500,
            content: 'To let me know your concern(s), mental well-being and help-seeking behaviour, please answer a few questions below. Once you have completed them, I will suggest the types of services or information you may connect with.<br/><br/> *The following questions are not supposed to treat as any formal psychological or diagnostic assessment.'
        }).then(function () {
            return botui.message.bot({
                delay: 500,
                content: 'Q1. What bring(s) you here to chat with us? (Can select more than one item)'
            }).then(function () {
                return botui.action.select({
                    action: {
                        placeholder: "Select a option",
                        multipleselect: true,
                        options: [
                            { text: 'Academic' },
                            { text: 'Relationship' },
                            { text: 'Career' },
                            { text: 'Family' },
                            { text: 'Mental Health' },
                            { text: 'Other' },
                        ],
                        button: {
                            icon: 'check',
                            label: 'OK'
                        }
                    }
                }).then(function (res) {
                    answers[1] = 'Q1. What bring(s) you here to chat with us? (Can select more than one item)<pre>&#9;</pre>' + res.text + '<pre>&#9;</pre>'
                    console.log(answers)
                    return botui.message.bot({
                        loading: true,
                        delay: 500,
                        content: 'I see, you are now facing the issue(s) comprising(' + res.text + ')'
                    })
                })
            })
        }).then(function () {
            return botui.message.bot({
                delay: 500,
                content: 'Q2. In facing the issues indicated, are you encountering the feeling of sadness, worry or tension now?'
            }).then(function () {
                return botui.action.button({
                    action: [
                        { text: 'Yes', value: 1 },
                        { text: 'No', value: 0 }
                    ]
                }).then(function (res) {
                    answers[2] = 'Q2. In facing the issues indicated, are you encountering the feeling of sadness, worry or tension now?<pre>&#9;</pre>' + res.text + '<pre>&#9;</pre>'
                    if (res.value == 0) {
                        return botui.message.bot({
                            loading: true,
                            delay: 500,
                            content: 'Keep it up! We encourage you to take a look at \"Mental Health 101\" to learn more tips for enhancing your psychological and mental wellness.'
                        }).then(mental_health_101).then(end());
                    }
                    score += res.value;
                    console.log(score);
                    return botui.message.bot({
                        loading: true,
                        delay: 500,
                        content: 'It is natural for us to experience these feelings in our daily life.'
                    })
                })
            })
        }).then(function () {
            return botui.message.bot({
                delay: 500,
                content: 'Q3. How often do you experience the feeling of sadness, worry or tension?'
            }).then(function () {
                return botui.action.button({
                    action: [
                        { text: 'Rarely', value: 1 },
                        { text: 'Seldom', value: 2 },
                        { text: 'Sometimes', value: 3 },
                        { text: 'Often', value: 4 },
                        { text: 'Always', value: 5 },
                    ]
                }).then(function (res) {
                    answers[3] = 'Q3. How often do you experience the feeling of sadness, worry or tension?<pre>&#9;</pre>' + res.text + '<pre>&#9;</pre>'
                    score += res.value;
                    console.log(score);
                    if (res.value > 3) {
                        return botui.message.bot({
                            delay: 500,
                            loading: true,
                            content: 'According to the Psychologist Nathaniel Branden, \"The fisrt step toward change is awareness.\" It aids our self-understanding and steps of healing to take.'
                        }).then(function () {
                            return botui.message.bot({
                                delay: 500,
                                loading: true,
                                content: 'You show aware of your feelings happening to you.'
                            })
                        })
                    } else {
                        return botui.message.bot({
                            delay: 500,
                            loading: true,
                            content: 'According to the Psychologist Nathaniel Branden, \"The fisrt step toward change is awareness.\" It aids our self-understanding and steps of healing to take.'
                        })
                    }
                })
            })
        }).then(function () {
            return botui.message.bot({
                delay: 500,
                content: 'Q4. How often is your daily life get affected by the feelings mentioned above?'
            }).then(function () {
                return botui.action.button({
                    action: [
                        { text: 'Rarely', value: 1 },
                        { text: 'Seldom', value: 2 },
                        { text: 'Sometimes', value: 3 },
                        { text: 'Often', value: 4 },
                        { text: 'Always', value: 5 },
                    ]
                }).then(function (res) {
                    answers[4] = 'Q4. How often is your daily life get affected by the feelings mentioned above?<pre>&#9;</pre>' + res.text + '<pre>&#9;</pre>'
                    score += res.value;
                    console.log(score);
                    if (res.value > 3) {
                        return botui.message.bot({
                            loading: true,
                            delay: 500,
                            content: 'You are aware that your daily life is getting affected by these feelings.'
                        })
                    }
                })
            })
        }).then(function () {
            return botui.message.bot({
                delay: 500,
                content: 'Q5. Have you been trying to cope with your sadness\/worry or tension through positive ways? (e.g. practising physical exercise, deep breathing, listening to music, etc.)'
            }).then(function () {
                return botui.action.button({
                    action: [
                        { text: 'Yes', value: 0 },
                        { text: 'No', value: 1 }
                    ]
                }).then(function (res) {
                    answers[5] = 'Q5. Have you been trying to cope with your sadness\/worry or tension through positive ways? (e.g. practising physical exercise, deep breathing, listening to music, etc.)<pre>&#9;</pre>' + res.text + '<pre>&#9;</pre>'
                    score += res.value;
                    console.log(score);
                    return botui.message.bot({
                        loading: true,
                        delay: 500,
                        content: 'It is crucial to find some positive coping strategies in dealing with the unsettled'
                    })
                })
            })
        }).then(function () {
            return botui.message.bot({
                delay: 500,
                content: 'Q6. Do you feel effective when using these coping strategies?'
            }).then(function () {
                return botui.action.button({
                    action: [
                        { text: 'Yes', value: 0 },
                        { text: 'No', value: 1 }
                    ]
                }).then(function (res) {
                    answers[6] = 'Q6. Do you feel effective when using these coping strategies?<pre>&#9;</pre>' + res.text + '<pre>&#9;</pre>'
                    score += res.value;
                    console.log(score);
                })
            })
        }).then(confirm_answer)
    }

    function confirm_answer() {
        return botui.message.bot({
            loading: true,
            delay: 500,
            content: 'Kindly confirm your answer:'
        }).then(function () {
            var temp = '';
            for (var i = 1; i <= 6; i++) {
                temp += '<br/>' + answers[i];
            }
            return botui.message.bot({
                delay: 500,
                content: temp
            })
        }).then(function () {
            return botui.action.button({
                action: [
                    { text: 'Submit', value: true },
                    { text: 'Cancel (Redirect to Q1)', value: false }
                ]
            })
        }).then(function (res) {
            if (res.value == false) {
                score = 0;
                answers = {};
                questions();
            } else {
                dispatch();
            }
        })
    }


    function dispatch() {
        if (score <= 6) {
            low();
        } else if (score <= 10) {
            medium();
        } else {
            high();
        }
    }

    function low() {
        return botui.message.bot({
            loading: true,
            delay: 500,
            content: 'Your answers show that you rarely or seldom encounter the feeling mentioned above, and you can manage your life well.'
        }).then(function () {
            return botui.message.bot({
                loading: true,
                delay: 500,
                content: 'Keep it up! We encourage you to take a look at the "Mental Health 101" to learn more tips for enhancing your psychological and mental wellness.'
            })
        }).then(mental_health_101)
    }


    function medium() {
        return botui.message.bot({
            loading: true,
            delay: 500,
            content: 'Your answers show that you quite often experience the feeling mentioned above, and you feel your daily life get affected sometimes.'
        }).then(function () {
            return botui.message.bot({
                loading: true,
                delay: 500,
                content: 'We recommend you to reach out our counsellors.<br/><br/>1. Making Appointment with Counsellors<br/><br/>Apart from that, you can choose other services as below:<br/><br/>2. Mental Health 101<br/>3. Immediate Contact with Counsellor/PolyU-Line<br/>4. Online Chat Service<br/>5. Community Helpline'
            })
        }).then(function () {
            if (office_hour == true) {
                return botui.action.button({
                    action: [
                        { text: 'Mental Health 101', value: 1 },
                        { text: 'Online Chat Service', value: 2 },
                        { text: 'Make Appointment with Counselors', value: 3 },
                        { text: 'Immediate Contact with Counsellors', value: 4 },
                        { text: 'Community Helpline', value: 6 },
                    ]
                })
            } else {
                return botui, action.button({
                    action: [
                        { text: 'Mental Health 101', value: 1 },
                        { text: 'Make Appointment with Counselors', value: 3 },
                        { text: 'PolyU-Line', value: 5 },
                        { text: 'Community Helpline', value: 6 },
                    ]
                })
            }
        }).then(function (res) {
            if (res.value == 1) {
                mental_health_101();
            }
            if (res.value == 2) {

            }
            if (res.value == 3) {

            }
            if (res.value == 4) {

            }
            if (res.value == 5) {

            }
            if (res.value == 6) {

            }
        })
    }

    function high() {
        return botui.message.bot({
            loading: true,
            delay: 500,
            content: 'Your answers show that you always experience the feeling mentioned above, and you feel your daily life always get affected.'
        }).then(function () {
            return botui.message.bot({
                loading: true,
                delay: 500,
                content: 'Please do not hestitate to seek for professional help.<br/><br/>1. Immediate Contact with Counsellor/PolyU-Line<br/><br/>Apart from that, you can choose other services as below:<br/><br/>2. Making Appointment with Counsellors at POSS<br/>3. Community Helpline'
            })
        }).then(function () {
            if (office_hour == true) {
                return botui.action.button({
                    action: [
                        { text: 'Make Appointment with Counselors', value: 3 },
                        { text: 'Immediate Contact with Counsellors', value: 4 },
                        { text: 'Community Helpline', value: 6 },
                    ]
                })
            } else {
                return botui, action.button({
                    action: [
                        { text: 'Make Appointment with Counselors', value: 3 },
                        { text: 'PolyU-Line', value: 5 },
                        { text: 'Community Helpline', value: 6 },
                    ]
                })
            }
        }).then(function (res) {
            if (res.value == 3) {

            }
            if (res.value == 4) {

            }
            if (res.value == 5) {

            }
            if (res.value == 6) {

            }
        })
    }

    function mental_health_101() {
        return botui.message.bot({
            loading: true,
            delay: 500,
            content: '...xxx...'//没太看明白
        }).then(function () {
            return botui.message.bot({
                loading: true,
                delay: 500,
                content: 'You are being directed to a third-party website.<br/>Although we have verified the accuracy of this link, the responsiblity of its content is still subject to ownership of third-party website.'
            })
        }).then(function () {
            return botui.message.bot({
                loading: true,
                delay: 500,
                content: 'Thank you for using \"My Polly\". May I assist you with anything further?'
            })
        }).then(function () {
            return botui.action.button({
                action: [
                    { text: 'No, thank you! I will stop here.', value: false },
                    { text: 'I still need other services.', value: true }
                ]
            })
        }).then(function (res) {
            if (res.value == false) {
                return botui.message.bot({
                    delay: 500,
                    content: 'Please rate your experience'
                }).then(function () {
                    // survery
                }).then(end)
            } else {
                return botui.message.bot({
                    loading: true,
                    delay: 500,
                    content: '1. Making Appointment with Counsellors<br/>2. Immediate Contact with Counsellor/PolyU-Line'
                }).then(function () {
                    if (office_hour == true) {
                        return botui.action.button({
                            action: [
                                { text: 'Make Appointment with Counselors', value: 1 },
                                { text: 'Immediate Contact with Counsellors', value: 2 },
                            ]
                        })
                    } else {
                        return botui, action.button({
                            action: [
                                { text: 'Make Appointment with Counselors', value: 1 },
                                { text: 'PolyU-Line', value: 3 },
                            ]
                        })
                    }
                }).then(function (res) {
                    if (res.value == 3) {

                    }
                    if (res.value == 4) {

                    }
                })
            }
        })
    }

    function confirm_chatting() {
        botui.message.add({
            delay: 1500,
            content: 'Or, you can also try our online chatting service'
        }).then(function () {
            return botui.action.button({
                addMessage: false,
                action: [{
                    text: 'OK',
                    value: 'yes'
                }, {
                    text: 'No',
                    value: 'no'
                }]
            })
        }).then(function (res) {
            if (res.value == 'no') {
                botui.message.human({
                    delay: 500,
                    content: 'No'
                });
                botui.message.add({
                    delay: 700,
                    content: 'Bye bye!'
                });
                end();
            } else {
                botui.message.human({
                    content: res.text
                });
                online_chatting();
            }
        });

    }
    function online_chatting() {
        botui.message.add({
            content: 'Hi ' + name + '! If you want to talk to the counselor, *[This is the T and C of our system]*, do you accept it?'
        }).then(function () {
            return botui.action.button({
                addMessage: false,
                action: [{
                    text: 'Yes',
                    value: 'yes'
                }, {
                    text: 'No',
                    value: 'no'
                }]
            })
        }).then(function (res) {
            if (res.value == 'no') {
                botui.message.human({
                    delay: 500,
                    content: 'No'
                });
                botui.message.add({
                    delay: 600,
                    content: 'Sorry! You can still call 2766 6800 for conselling.'
                });
                botui.message.add({
                    delay: 700,
                    content: 'Bye bye!'
                });
                end();
            } else {
                botui.message.human({
                    content: res.text
                });
                botui.message.add({
                    content: 'Some questions before online chatting'
                }).then(questions_before_online_chatting())
            }
        });
    }

    function questions_before_online_chatting() {

        botui.message.add({
            delay: 700,
            content: 'Is it an existing case?'
        }).then(function () {
            return botui.action.button({
                addMessage: false,
                action: [{
                    text: 'Yes',
                    value: 'yes'
                }, {
                    text: 'No',
                    value: 'no'
                }]
            })
        }).then(function (res) {
            botui.message.human({
                content: res.text
            });
            if (res.value == 'yes') {
                botui.message.add('We provide you several suggestions: <br/><br/> 1. Make appointment with existing counsellor in [POSS](https://www40.polyu.edu.hk/poss/secure/login/loginhome.do/) <br/> 2. Refer to [Mental Health 101](https://www.google.com/)')
                // option 1
                // option 2
            } else {
                botui.message.add({
                    delay: 700,
                    content: 'Do you have mental health history?'
                }).then(function () {

                    return botui.action.button({
                        addMessage: false,
                        action: [{
                            text: 'Yes',
                            value: 'yes'
                        }, {
                            text: 'No',
                            value: 'no'
                        }]
                    })
                }).then(function (res) {
                    if (res.value == 'yes') {
                        botui.message.human({
                            content: res.text
                        });
                        if (office_hour == true) {
                            botui.message.add({
                                content: 'We provide you several suggestions: <br/><br/> 1. Call 2766 6800 <br/> 2. Make appointment with counsellor in [POSS](https://www40.polyu.edu.hk/poss/secure/login/loginhome.do/)   <br/> '
                            });
                        }
                        else {
                            botui.message.add({
                                content: 'Sorry, currently it is not the office hour, we advice you to call PolyU LINE 8100 1583'
                            })
                        }
                    } else {
                        process_to_online_chat();
                    }
                })
            }
        })
    }

    function process_to_online_chat() {
        var service_hour = true;
        if (service_hour == false) {
            botui.message.add({
                content: 'Sorry, it is not service hour, no counsellor avaliable now.'
            })
        } else {
            // online_chatting_request
        }
    }
    /*
    function chatting () {
        botui.action.text({ // show 'text' action
                action: {
                    placeholder: 'Enter here'
                }
        }).then(function (res) { // get the result
            if(res.value != 'exit') {
                $(this).ajaxSubmit({
                  type: 'post',
                  url: "{% url 'auto_response' %}",
                  data:{
                      'post': res.value
                  },
                  success: function(data) {
                      response = data;
                      botui.message.add({
                        content: response
                      }).then(chatting())
                  }
                });
            } else {
                botui.message.add({
                    content: 'Bye bye!'
                });
            }
        });
    }
    */







</script>

</html>